<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>農藝丙級術科識別線上模擬測驗（DEBUG 版）</title>
  <style>
    :root{ --bg:#f5f7fa; --card:#ffffff; --text:#1e293b; --sub:#475569; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --muted:#cbd5e1; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC";background:#f5f7fa;color:#1e293b}
    .container{max-width:1000px;margin:0 auto;padding:20px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:18px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #cbd5e1;background:#f1f5f9;color:#1e293b;cursor:pointer}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#e2e8f0;border:1px solid #cbd5e1;color:#1e293b;font-size:12px}
    .muted{color:#64748b}
    #debugLog{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1021;color:#d1fae5;border-radius:10px;padding:12px;max-height:220px;overflow:auto}
    .hint{font-size:12px;color:#b91c1c;margin-left:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 style="display:inline-block;margin-right:8px">農藝丙級術科識別線上模擬測驗</h1>
      <span class="badge" id="badgeVersion">ver —</span>
    </div>

    <div class="card">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
        <div>
          <label>姓名/代號</label><br/>
          <input id="username" placeholder="例如：王小明 / YZ001" style="padding:10px;border-radius:10px;border:1px solid #cbd5e1;width:260px">
        </div>
        <div>
          <label>類別</label><br/>
          <select id="testType" style="padding:10px;border-radius:10px;border:1px solid #cbd5e1;width:260px">
            <option value="" selected>— 請選擇 —</option>
            <option value="A">A. 認識作物（50 題）</option>
            <option value="B">B. 病蟲草害（40 題）</option>
          </select>
        </div>
        <div>
          <!-- 不使用 disabled，並加上 inline onclick 保證可點擊 -->
          <button id="btnStart" class="btn primary" onclick="window.startClicked && window.startClicked()">▶ 開始測驗</button>
          <span id="startHint" class="hint"></span>
        </div>
        <div>
          <button id="btnDemo" class="btn" onclick="window.startDemo && window.startDemo()">快速體驗（10 題）</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="badge">DEBUG</div>
      <div id="debugLog">載入中…</div>
    </div>
  </div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const log=(...args)=>{ const line=args.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '); console.log('[DEBUG]', ...args); const el=$('#debugLog'); el.textContent += (el.textContent? '\\n':'') + line; };

  // 攔截所有未捕捉錯誤，顯示在畫面上
  window.onerror = function(msg, src, line, col, err){
    log('❌ JS Error:', msg, 'at', src+':'+line+':'+col);
  };

  // 版本 + 題庫載入測試
  async function loadQuestions(){
    try{
      const res = await fetch('questions.json?ts='+Date.now(), {cache:'no-store'});
      log('questions.json HTTP', res.status);
      const obj = await res.json();
      log('questions.json keys:', Object.keys(obj));
      if(obj.version) $('#badgeVersion').textContent = 'ver '+obj.version;
      return obj;
    }catch(e){
      log('讀取 questions.json 失敗：'+e);
      return {A:[],B1:[],B2:[],version:'v-unknown'};
    }
  }

  // 開始測驗的驗證（不使用 disabled）
  function validate(){
    const name=$('#username').value.trim();
    const type=$('#testType').value;
    const hint=$('#startHint'); hint.textContent='';
    if(!name || !type){
      hint.textContent = (!name && !type)? '請輸入姓名並選擇類別' : (!name? '請輸入姓名' : '請選擇類別');
      log('阻擋開始：', hint.textContent);
      return false;
    }
    return true;
  }

  // 供 inline onclick 呼叫
  window.startClicked = async function(){
    log('startClicked() 被呼叫');
    if(!validate()) return;
    const q = await loadQuestions();
    log('OK, 會進入正式作答流程（此 DEBUG 版僅驗證互動，不包含全功能 UI）');
    alert('驗證通過：'+$('#username').value+' / '+$('#testType').value+'\\nquestions.json 版號：'+(q.version||'—'));
  };
  window.startDemo = async function(){
    log('startDemo() 被呼叫');
    if(!$('#username').value.trim()) $('#username').value='DEMO';
    if(!$('#testType').value) $('#testType').value='A';
    const q = await loadQuestions();
    log('OK, 會進入 DEMO 作答流程（此 DEBUG 版僅驗證互動）');
    alert('Demo 模式啟動：'+$('#username').value+' / '+$('#testType').value+'\\nquestions.json 版號：'+(q.version||'—'));
  };

  // 初始化：寫明我們正在使用 inline onclick，所以即使 addEventListener 失效仍可點
  log('頁面初始化完成，按鈕使用 inline onclick 保證可點擊');
  // 額外再綁 addEventListener（若成功，就能雙保險）
  document.getElementById('btnStart')?.addEventListener('click', ()=>window.startClicked());
  document.getElementById('btnDemo')?.addEventListener('click', ()=>window.startDemo());

  // 預先讀一次題庫以顯示版本（不影響開始）
  loadQuestions();
})();
</script>
</body>
</html>
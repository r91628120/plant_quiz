<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>農藝丙級術科識別線上模擬測驗</title>
  <!-- 省略部分 CSS 與 HTML，這裡放的是修正版結構 -->
  <!-- 內含 CLOUD_OK 檢查、雲端狀態徽章、CORS fallback -->
</head>
<body>
  <h1>農藝丙級術科識別線上模擬測驗</h1>
  <h2>🏆 成績排行榜（TOP 10） <span class="badge" id="cloudBadge">雲端：檢查中…</span></h2>
  <script>
    const API_BASE = 'https://asia-east1-agri-plant-quiz.cloudfunctions.net/api';
    let CLOUD_OK = false;
    async function cloudSubmitScore(record){
      try{
        if(!CLOUD_OK) return null;
        const res = await fetch(API_BASE + '/submit', {
          method:'POST', mode:'cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(record)
        });
        if(!res.ok) throw new Error('submit failed '+res.status);
        return await res.json();
      }catch(e){ console.warn('submit error', e); return null; }
    }
    async function cloudFetchTop10(){
      try{
        if(!CLOUD_OK) return [];
        const res = await fetch(API_BASE + '/top10', {mode:'cors'});
        if(!res.ok) throw new Error('fetch top10 failed '+res.status);
        return await res.json();
      }catch(e){ console.warn('top10 error', e); return []; }
    }
    (async function init(){
      try{
        const ctl=new AbortController(); const t=setTimeout(()=>ctl.abort(),6000);
        const ping=await fetch(API_BASE+'/top10',{mode:'cors',signal:ctl.signal});
        clearTimeout(t);
        if(ping.ok){ CLOUD_OK=true; document.getElementById('cloudBadge').textContent='雲端：連線正常'; }
        else { document.getElementById('cloudBadge').textContent='雲端：未連線（改用本機）'; }
      }catch(e){
        document.getElementById('cloudBadge').textContent='雲端：未連線（改用本機）';
      }
    })();
  </script>
</body>
</html>
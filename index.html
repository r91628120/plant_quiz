<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¾²è—ä¸™ç´šè¡“ç§‘è­˜åˆ¥ç·šä¸Šæ¨¡æ“¬æ¸¬é©—ï¼ˆç©©å®šç‰ˆï½œç„¡æ’è¡Œæ¦œï¼‰</title>
  <style>
    :root{ --bg:#f5f7fa; --card:#ffffff; --text:#1e293b; --sub:#475569; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --muted:#cbd5e1; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:linear-gradient(180deg,#f9fafb,#f1f5f9 20%,#e2e8f0);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    h1{font-size:28px;margin:0 0 12px}
    h2{font-size:20px;color:#64748b;margin:0 0 12px}
    .row{display:flex;flex-wrap:wrap;gap:16px}
    .col{flex:1 1 320px}
    label{display:block;margin-bottom:8px;color:#334155}
    input[type="text"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:#1e293b}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:12px;border:1px solid #cbd5e1;background:#f1f5f9;color:#1e293b;text-decoration:none;cursor:pointer;font-weight:600;transition:all .2s ease}
    .btn:hover{background:#e2e8f0;border-color:#94a3b8}
    .btn.primary{border-color:#2563eb;background:#2563eb;color:#fff}
    .btn.primary:hover{background:#3b82f6;border-color:#2563eb}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#e2e8f0;border:1px solid #cbd5e1;color:#1e293b;font-size:12px}
    .progress{height:8px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,#2563eb,#60a5fa);width:0}
    .quiz-img{width:100%;max-height:360px;object-fit:contain;border-radius:14px;background:#f1f5f9;border:1px solid #cbd5e1}
    .choices{display:grid;gap:10px;margin-top:12px}
    .choice{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:12px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;transition:all .2s ease}
    .choice:hover{background:#e2e8f0}
    .palette{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .palette button{width:34px;height:34px;border-radius:10px;border:1px solid #cbd5e1;background:#f1f5f9;color:#1e293b;cursor:pointer;transition:all .2s ease}
    .palette button.answered{border-color:#2563eb;background:#dbeafe}
    .palette button.current{outline:2px solid #2563eb}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .debug{white-space:pre-wrap;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;padding:10px;color:#0f172a}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="view-home">
      <div class="toolbar" style="justify-content:space-between">
        <div>
          <h1 style="display:inline-block;margin-right:8px">è¾²è—ä¸™ç´šè¡“ç§‘è­˜åˆ¥ç·šä¸Šæ¨¡æ“¬æ¸¬é©—</h1>
          <span class="badge" id="badgeVersion">ver â€”</span>
        </div>
        <button id="btnExportQ" class="btn">åŒ¯å‡ºé¡Œåº« JSON</button>
      </div>

      <div id="debugBox" class="debug">ğŸ›  è¼‰å…¥ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­â€¦</div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <label for="username">è«‹è¼¸å…¥å§“åæˆ–ä»£è™Ÿ</label>
          <input id="username" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ / YZ001" />
        </div>
        <div class="col">
          <label for="testType">é¸æ“‡æ¸¬é©—é¡åˆ¥</label>
          <select id="testType">
            <option value="" selected>â€” è«‹é¸æ“‡ â€”</option>
            <option value="A">A. èªè­˜ä½œç‰©ï¼ˆ50 é¡Œï¼Œ20 åˆ†é˜ï¼‰</option>
            <option value="B">B. ç—…èŸ²è‰å®³è­˜åˆ¥èˆ‡é˜²æ²»ï¼ˆ40 é¡Œï¼Œ20 åˆ†é˜ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="toolbar">
        <button id="btnStart" class="btn primary">â–¶ é–‹å§‹æ¸¬é©—</button>
        <button id="btnDemo" class="btn">å¿«é€Ÿé«”é©—ï¼ˆ10 é¡Œï¼‰</button>
      </div>
    </div>

    <div id="view-quiz" class="card" style="display:none">
      <div class="toolbar" style="justify-content:space-between">
        <div>
          <span class="badge" id="badgeType"></span>
          <span class="badge" id="badgeName"></span>
          <span class="badge" id="badgeVersion2"></span>
        </div>
        <div><span class="badge" id="timer">20:00</span></div>
      </div>
      <div class="progress"><span id="bar"></span></div>
      <div id="qwrap" style="margin-top:12px"></div>
      <div class="toolbar">
        <button class="btn" id="btnPrev">â† ä¸Šä¸€é¡Œ</button>
        <button class="btn" id="btnNext">ä¸‹ä¸€é¡Œ â†’</button>
        <button class="btn primary" id="btnSubmit">äº¤å·</button>
      </div>
      <div class="palette" id="palette"></div>
    </div>

    <div id="view-result" class="card" style="display:none">
      <h2>æ¸¬é©—çµæœ</h2>
      <p>
        <span class="badge" id="resName"></span>
        <span class="badge" id="resType"></span>
        <span class="badge" id="resScore"></span>
        <span class="badge" id="resPass"></span>
        <span class="badge" id="resVersion"></span>
      </p>
      <div class="toolbar">
        <button class="btn" id="btnDownloadCSV">ä¸‹è¼‰ CSV</button>
        <button class="btn" id="btnDownloadJSON">ä¸‹è¼‰ JSON</button>
        <button class="btn" id="btnPrint">åˆ—å° / å­˜æˆ PDF</button>
        <button class="btn" id="btnAgain">å›é¦–é å†æ¸¬ä¸€æ¬¡</button>
      </div>
      <div style="margin-top:14px;overflow:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr><th style="width:72px;text-align:left">é¡Œè™Ÿ</th><th style="text-align:left">åœ–ç‰‡</th><th style="text-align:left">ä½ çš„ç­”æ¡ˆ</th><th style="text-align:left">æ­£ç¢ºç­”æ¡ˆ</th><th style="text-align:left">åˆ¤å®š</th></tr></thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// ========= å°å·¥å…· =========
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const shuffle = (a)=>a.map(x=>[Math.random(),x]).sort((u,v)=>u[0]-v[0]).map(x=>x[1]);
const sampleN = (a,n)=>shuffle(a).slice(0,Math.min(n,a.length));
const download=(fn,txt,type='application/json;charset=utf-8')=>{const blob=new Blob([txt],{type});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=fn;a.click();setTimeout(()=>URL.revokeObjectURL(url),1e3);};
const toView=(id)=>['#view-home','#view-quiz','#view-result'].forEach(v=>$(v).style.display=(v===id)?'block':'none');
const dbg=(m)=>{ const el=$('#debugBox'); el.textContent+=(el.textContent?'\\n':'')+m; console.log('[DEBUG]',m); };

// ========= é¡Œåº«ï¼šGCS + æœ¬åœ° fallback =========
let QUIZ_VERSION='v1.0.0', BANK_A=[], BANK_B1=[], BANK_B2=[];
const Q_GCS_URL = 'https://storage.googleapis.com/agri_plant_quiz/questions.json';
async function loadQuestions(){
  const urls=[ Q_GCS_URL + '?t=' + Date.now(), 'questions.json?t=' + Date.now() ];
  let obj=null, err=null;
  for(const u of urls){
    try{
      dbg('å˜—è©¦è¼‰å…¥ï¼š'+u);
      const r = await fetch(u, {cache:'no-store'});
      dbg('HTTP ç‹€æ…‹ï¼š'+r.status);
      if(!r.ok) throw new Error('HTTP '+r.status);
      obj = await r.json(); break;
    }catch(e){ err=e; dbg('è¼‰å…¥å¤±æ•—ï¼š'+e.message); }
  }
  if(!obj) throw err || new Error('ç„¡æ³•è¼‰å…¥é¡Œåº«');
  QUIZ_VERSION = obj.version || QUIZ_VERSION;
  BANK_A = Array.isArray(obj.A)?obj.A:[];
  BANK_B1= Array.isArray(obj.B1)?obj.B1:[];
  BANK_B2= Array.isArray(obj.B2)?obj.B2:[];
  $('#badgeVersion').textContent = 'ver '+QUIZ_VERSION;
  dbg(`âœ… é¡Œåº«è¼‰å…¥æˆåŠŸï¼šver ${QUIZ_VERSION}ï¼ŒA=${BANK_A.length}ï¼ŒB1=${BANK_B1.length}ï¼ŒB2=${BANK_B2.length}`);
}

// ========= ä½œç­”é‚è¼¯ï¼ˆç„¡æ’è¡Œæ¦œï¼‰ =========
const STATE={ user:'', type:'', questions:[], idx:0, timerSec:20*60, score:0 };
let timerId=null;
function buildQuestions(type,{demo=false}={}){
  const bank=(type==='A')?[...BANK_A]:[...BANK_B1,...BANK_B2];
  const TARGET=type==='A'?50:40; const count=demo?Math.min(10,bank.length):TARGET;
  const picked=sampleN(bank,count); const namesAll=bank.map(x=>x.name);
  return picked.map(q=>{ const wrongs=sampleN(namesAll.filter(n=>n!==q.name),3); const options=shuffle([q.name,...wrongs]); return { image:q.image, options, answer:q.name, your:null }; });
}
function renderProgress(){ $('#bar').style.width = ((STATE.idx+1)/STATE.questions.length*100)+'%'; }
function renderQuestion(){
  const q=STATE.questions[STATE.idx], total=STATE.questions.length;
  const html=`<div style="margin:6px 0 10px"><span class="badge">ç¬¬ ${STATE.idx+1} / ${total} é¡Œ</span></div>
  <img class="quiz-img" src="${q.image}" alt="è©¦é¡Œåœ–ç‰‡" onerror="this.src='https://placehold.co/900x600?text=Image'">
  <div class="choices">${q.options.map((opt,i)=>{
    const id=\`opt${STATE.idx}_${i}\`; const checked=q.your===opt?'checked':'';
    return \`<label class="choice"><input type="radio" name="q${STATE.idx}" id="${id}" value="${opt}" ${checked}> <span>${opt}</span></label>\`;
  }).join('')}</div>`;
  $('#qwrap').innerHTML=html;
  $$('#qwrap input[type=radio]').forEach(el=>el.addEventListener('change',(e)=>{ STATE.questions[STATE.idx].your=e.target.value; renderPalette(); }));
  $('#btnPrev').disabled=STATE.idx===0; $('#btnNext').disabled=STATE.idx===total-1;
}
function renderPalette(){
  const frag=document.createDocumentFragment();
  STATE.questions.forEach((q,i)=>{ const b=document.createElement('button'); b.textContent=i+1; if(q.your) b.classList.add('answered'); if(i===STATE.idx) b.classList.add('current'); b.addEventListener('click',()=>{STATE.idx=i; renderQuestion(); renderProgress();}); frag.appendChild(b); });
  const p=$('#palette'); p.innerHTML=''; p.appendChild(frag);
}
function startTimer(){
  clearInterval(timerId);
  timerId=setInterval(()=>{ STATE.timerSec--; if(STATE.timerSec<=0){ STATE.timerSec=0; updateTimer(); clearInterval(timerId); submitQuiz(true);} else updateTimer(); },1000);
  updateTimer();
}
function updateTimer(){ const m=Math.floor(STATE.timerSec/60), s=STATE.timerSec%60; $('#timer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
function computeScore(){
  const per=(STATE.type==='A')?2:2.5; let correct=0;
  STATE.questions.forEach(q=>{ if(q.your===q.answer) correct++; });
  STATE.score=+(correct*per).toFixed(2);
}
function submitQuiz(auto=false){
  clearInterval(timerId);
  computeScore();
  $('#resName').textContent = `æ‡‰è©¦è€…ï¼š${STATE.user}`;
  $('#resType').textContent = `é¡åˆ¥ï¼š${STATE.type==='A'?'A. èªè­˜ä½œç‰©':'B. ç—…èŸ²è‰å®³èˆ‡é˜²æ²»'}`;
  $('#resScore').textContent = `å¾—åˆ†ï¼š${STATE.score} åˆ†`;
  const passEl=$('#resPass'); passEl.textContent=(STATE.score>=60)?'çµæœï¼šåŠæ ¼':'çµæœï¼šä¸åŠæ ¼';
  $('#resVersion').textContent = 'ver '+QUIZ_VERSION;
  const tbody=document.createDocumentFragment();
  STATE.questions.forEach((q,i)=>{ const tr=document.createElement('tr'); const ok=q.your===q.answer; tr.innerHTML=`<td>${i+1}</td><td><img src="${q.image}" style="width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #cbd5e1"></td><td>${q.your||'<span style="color:#64748b">æœªä½œç­”</span>'}</td><td>${q.answer}</td><td>${ ok ? 'âœ” æ­£ç¢º' : 'âœ˜ éŒ¯èª¤'}</td>`; tbody.appendChild(tr); });
  $('#resultBody').innerHTML=''; $('#resultBody').appendChild(tbody);
  toView('#view-result');
}

// ===== åŒ¯å‡º =====
$('#btnExportQ').addEventListener('click',()=>{
  const obj={version:QUIZ_VERSION,A:BANK_A,B1:BANK_B1,B2:BANK_B2};
  download(`questions_${QUIZ_VERSION}.json`, JSON.stringify(obj,null,2));
});
$('#btnDownloadCSV').addEventListener('click',()=>{
  const header=['name','type','version','score','index','your','answer','correct','image']; const rows=[];
  STATE.questions.forEach((q,i)=>rows.push([STATE.user,STATE.type,QUIZ_VERSION,STATE.score,i+1,q.your||'',q.answer,(q.your===q.answer)?'1':'0',q.image]));
  const lines=[header.join(','), ...rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','))];
  download(`agri_quiz_${Date.now()}.csv`, lines.join('\\n'), 'text/csv;charset=utf-8');
});
$('#btnDownloadJSON').addEventListener('click',()=>{
  const obj={ name:STATE.user, type:STATE.type, version:QUIZ_VERSION, score:STATE.score, items:STATE.questions.map((q,i)=>({ index:i+1, your:q.your, answer:q.answer, correct:q.your===q.answer, image:q.image })) };
  download(`agri_quiz_${Date.now()}.json`, JSON.stringify(obj,null,2));
});
$('#btnPrint').addEventListener('click',()=>window.print());
$('#btnAgain').addEventListener('click',()=>{ toView('#view-home'); });

// ===== å•Ÿå‹• =====
async function start(demo=false){
  try{
    if(!BANK_A.length && !BANK_B1.length && !BANK_B2.length){ await loadQuestions(); }
    const name=$('#username').value.trim() || 'DEMO';
    const type=$('#testType').value || 'A';
    STATE.user=name; STATE.type=type; STATE.questions=buildQuestions(type,{demo}); STATE.idx=0; STATE.timerSec=20*60; STATE.score=0;
    $('#badgeType').textContent= (type==='A'?'A. èªè­˜ä½œç‰©':'B. ç—…èŸ²è‰å®³èˆ‡é˜²æ²»');
    $('#badgeName').textContent = name;
    $('#badgeVersion2').textContent = 'ver ' + QUIZ_VERSION;
    toView('#view-quiz'); renderQuestion(); renderPalette(); renderProgress(); startTimer();
  }catch(e){ alert('é¡Œåº«è¼‰å…¥å¤±æ•—ï¼š'+e.message); }
}
$('#btnStart').addEventListener('click', ()=>start(false));
$('#btnDemo').addEventListener('click', ()=>{ if(!$('#username').value.trim()) $('#username').value='DEMO'; if(!$('#testType').value) $('#testType').value='A'; start(true);});
$('#btnPrev').addEventListener('click', ()=>{ if(STATE.idx>0){ STATE.idx--; renderQuestion(); renderProgress(); }});
$('#btnNext').addEventListener('click', ()=>{ if(STATE.idx<STATE.questions.length-1){ STATE.idx++; renderQuestion(); renderProgress(); }});
$('#btnSubmit').addEventListener('click', ()=>submitQuiz(false));

// åˆå§‹åŒ–å°±å…ˆè¼‰é¡Œï¼ˆé¡¯ç¤ºç‰ˆæœ¬è™Ÿï¼‰ï¼›å¤±æ•—ä¸æ“‹ä½¿ç”¨è€…
loadQuestions().catch(e=>dbg('åˆå§‹åŒ–å¤±æ•—ï¼š'+e.message));
</script>
</body>
</html>

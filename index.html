<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¾²è—ä¸™ç´šè¡“ç§‘è­˜åˆ¥ç·šä¸Šæ¨¡æ“¬æ¸¬é©—</title>
  <!-- å®‰å…¨ï¼šä¸å«ä»»ä½•é‡‘é‘°ï¼›é¡Œåº«ä»¥ fetch åŒç›®éŒ„ questions.json è¼‰å…¥ -->
  <style>
    :root{ --bg:#f5f7fa; --card:#ffffff; --text:#1e293b; --sub:#475569; --accent:#2563eb; --good:#16a34a; --bad:#dc2626; --muted:#cbd5e1; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:linear-gradient(180deg,#f9fafb,#f1f5f9 20%,#e2e8f0);color:var(--text)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    h1{font-size:28px;margin:0 0 12px}
    h2{font-size:20px;color:var(--sub);margin:0 0 12px}
    p{color:#334155}
    .row{display:flex;flex-wrap:wrap;gap:16px}
    .col{flex:1 1 320px}
    label{display:block;margin-bottom:8px;color:#334155}
    input[type="text"],select{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;color:var(--text)}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:12px;border:1px solid #cbd5e1;background:#f1f5f9;color:var(--text);text-decoration:none;cursor:pointer;font-weight:600;transition:all .2s ease}
    .btn:hover{background:#e2e8f0;border-color:#94a3b8}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{border-color:#2563eb;background:#2563eb;color:#fff}
    .btn.primary:hover{background:#3b82f6;border-color:#2563eb}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#e2e8f0;border:1px solid #cbd5e1;color:#1e293b;font-size:12px}
    .muted{color:#94a3b8}
    .grid{display:grid;gap:16px}
    .grid.columns-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .progress{height:8px;background:#e2e8f0;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,#2563eb,#60a5fa);width:0}
    .quiz-img{width:100%;max-height:360px;object-fit:contain;border-radius:14px;background:#f1f5f9;border:1px solid #cbd5e1}
    .choices{display:grid;gap:10px;margin-top:12px}
    .choice{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:12px;border:1px solid #cbd5e1;background:#f8fafc;cursor:pointer;transition:all .2s ease}
    .choice:hover{background:#e2e8f0}
    .choice input{transform:translateY(3px)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .pill{padding:6px 10px;border-radius:10px;background:#f1f5f9;border:1px solid #cbd5e1;color:#1e293b;font-size:12px}
    .palette{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .palette button{width:34px;height:34px;border-radius:10px;border:1px solid #cbd5e1;background:#f1f5f9;color:#1e293b;cursor:pointer;transition:all .2s ease}
    .palette button:hover{background:#e2e8f0}
    .palette button.answered{border-color:#2563eb;background:#dbeafe}
    .palette button.current{outline:2px solid #2563eb}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left}
    tr:hover td{background:#f1f5f9}
    .ok{color:var(--good);font-weight:700}
    .ng{color:var(--bad);font-weight:700}
    .disclaimer{font-size:12px;color:#64748b}
    .footer{margin-top:20px;color:#64748b}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .notice{padding:10px 12px;border-radius:10px;background:#f1f5f9;border:1px solid #cbd5e1;color:#1e293b}
    @media (max-width:720px){.grid.columns-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="view-home" role="region" aria-label="é¦–é ">
      <div class="topbar">
        <div>
          <h1 style="display:inline-block;margin-right:8px">è¾²è—ä¸™ç´šè¡“ç§‘è­˜åˆ¥ç·šä¸Šæ¨¡æ“¬æ¸¬é©—</h1>
          <span class="badge" id="badgeVersion">ver â€”</span>
        </div>
        <div class="toolbar">
          <button id="btnExportQ" class="btn" title="ä¸‹è¼‰ç›®å‰é¡Œåº«ç‚º questions.json">åŒ¯å‡ºé¡Œåº« JSON</button>
        </div>
      </div>

      <div id="resumeBar" class="notice" style="display:none;margin-bottom:12px">
        åµæ¸¬åˆ°å°šæœªå®Œæˆçš„æ¸¬é©—é€²åº¦ï¼ˆ<span id="resumeInfo"></span>ï¼‰ã€‚
        <div class="toolbar" style="margin-top:8px">
          <button id="btnResume" class="btn primary">ç¹¼çºŒä½œç­”</button>
          <button id="btnDiscard" class="btn">æ”¾æ£„æœ¬æ¬¡æ¸¬é©—</button>
        </div>
      </div>

      <p class="muted">æœ¬é æœƒè‡ªå‹•å¾åŒç›®éŒ„ <code>questions.json</code> è¼‰å…¥é¡Œåº«ï¼Œå®‰å…¨ç„¡é‡‘é‘°ï¼›éƒ¨ç½²æ–¼ GitHub Pages å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
      <div class="row">
        <div class="col">
          <label for="username">è«‹è¼¸å…¥å§“åæˆ–ä»£è™Ÿ</label>
          <input id="username" type="text" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜ / YZ001" />
        </div>
        <div class="col">
          <label for="testType">é¸æ“‡æ¸¬é©—é¡åˆ¥</label>
          <select id="testType">
            <option value="" selected>â€” è«‹é¸æ“‡ â€”</option>
            <option value="A">A. èªè­˜ä½œç‰©ï¼ˆ50 é¡Œï¼Œ20 åˆ†é˜ï¼‰</option>
            <option value="B">B. ç—…èŸ²è‰å®³è­˜åˆ¥èˆ‡é˜²æ²»ï¼ˆ40 é¡Œï¼Œ20 åˆ†é˜ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="topbar">
        <div>
          <span class="badge">ç›®å‰ç´¯è¨ˆæ¸¬é©—äººæ•¸</span>
          <span id="peopleCount" class="badge" style="margin-left:6px;background:#e2e8f0">000000 äºº</span>
        </div>
        <div class="toolbar">
          <button id="btnStart" class="btn primary" disabled>â–¶ é–‹å§‹æ¸¬é©—</button>
          <button id="btnDemo" class="btn" title="ä½¿ç”¨å°‘é‡ç¤ºä¾‹é¡Œç«‹å³é«”é©—">å¿«é€Ÿé«”é©—ï¼ˆ10 é¡Œï¼‰</button>
        </div>
      </div>

      <div class="grid columns-2">
        <div>
          <h2>A. èªè­˜ä½œç‰©</h2>
          <p class="disclaimer">ä¸€æ¬¡ 50 é¡Œï¼Œæ¯é¡Œ 2 åˆ†ï¼Œæ»¿åˆ† 100ï¼ŒåŠæ ¼ 60ï¼Œé™æ™‚ 20 åˆ†é˜ã€‚</p>
        </div>
        <div>
          <h2>B. ç—…èŸ²è‰å®³è­˜åˆ¥èˆ‡é˜²æ²»</h2>
          <p class="disclaimer">ä¸€æ¬¡ 40 é¡Œï¼Œæ¯é¡Œ 2.5 åˆ†ï¼Œæ»¿åˆ† 100ï¼ŒåŠæ ¼ 60ï¼Œé™æ™‚ 20 åˆ†é˜ã€‚</p>
        </div>
      </div>

      <div style="margin-top:16px" class="card">
        <h2>ğŸ† æˆç¸¾æ’è¡Œæ¦œï¼ˆTOP 10ï¼‰ <span class="badge" id="cloudBadge" style="margin-left:8px">é›²ç«¯ï¼šæª¢æŸ¥ä¸­â€¦</span></h2>
        <div class="disclaimer">é›²ç«¯æ’è¡Œæ¦œä»¥ Firebase ç‚ºä¸»ï¼Œå¤±æ•—æ™‚é¡¯ç¤ºæœ¬æ©Ÿ Demoã€‚</div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>åæ¬¡</th><th>å§“å/ä»£è™Ÿ</th><th>é¡åˆ¥</th><th>åˆ†æ•¸</th><th>æ—¥æœŸ</th><th>ç‰ˆæœ¬</th>
              </tr>
            </thead>
            <tbody id="boardBody"><tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="view-quiz" class="card" style="display:none" role="region" aria-label="ä½œç­”ç•«é¢">
      <div class="topbar">
        <div>
          <span class="badge" id="badgeType"></span>
          <span class="badge" id="badgeName" style="margin-left:6px"></span>
          <span class="badge" id="badgeVersion2" style="margin-left:6px"></span>
        </div>
        <div class="toolbar">
          <span class="pill" id="timer">20:00</span>
          <button class="btn" id="btnSubmit">äº¤å·</button>
        </div>
      </div>
      <div class="progress" aria-hidden="true"><span id="bar"></span></div>
      <div id="qwrap" style="margin-top:12px"></div>
      <div class="toolbar">
        <button class="btn" id="btnPrev">â† ä¸Šä¸€é¡Œ</button>
        <button class="btn" id="btnNext">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
      <div style="margin-top:10px">
        <div class="badge">é¡Œç›®å°è¦½</div>
        <div id="palette" class="palette" aria-label="é¡Œè™Ÿå°è¦½"></div>
      </div>
      <div class="footer">
        <div class="disclaimer">èªªæ˜ï¼šå¯å‰å¾Œé–±è¦–ä½œç­”ï¼Œæ™‚é–“åˆ°è‡ªå‹•äº¤å·ã€‚é€²åº¦æ¯ 5 ç§’è‡ªå‹•å„²å­˜ï¼Œå¯ä¸­æ–·çºŒç­”ï¼ˆåŒç‰ˆæœ¬ï¼‰ã€‚</div>
      </div>
    </div>

    <div id="view-result" class="card" style="display:none" role="region" aria-label="çµæœé ">
      <h2>æ¸¬é©—çµæœ</h2>
      <p>
        <span class="badge" id="resName"></span>
        <span class="badge" id="resType" style="margin-left:6px"></span>
        <span class="badge" id="resScore" style="margin-left:6px"></span>
        <span class="badge" id="resPass" style="margin-left:6px"></span>
        <span class="badge" id="resVersion" style="margin-left:6px"></span>
      </p>
      <div class="toolbar">
        <button class="btn" id="btnDownloadCSV">ä¸‹è¼‰ CSV</button>
        <button class="btn" id="btnDownloadJSON">ä¸‹è¼‰ JSON</button>
        <button class="btn" id="btnPrint">åˆ—å° / å­˜æˆ PDF</button>
        <button class="btn primary" id="btnAgain">å›é¦–é å†æ¸¬ä¸€æ¬¡</button>
      </div>
      <div style="margin-top:14px;overflow:auto">
        <table>
          <thead><tr><th style="width:72px">é¡Œè™Ÿ</th><th>åœ–ç‰‡</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>åˆ¤å®š</th></tr></thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  // ========= é¡Œåº«ï¼šè‡ªå‹•è¼‰å…¥åŒç›®éŒ„ questions.json =========
  let QUIZ_VERSION = 'v1.0.0';
  let BANK_A=[], BANK_B1=[], BANK_B2=[];

  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
  const shuffle = (arr)=>arr.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const sampleN = (arr,n)=>shuffle(arr).slice(0,Math.min(n,arr.length));
  const download=(filename,text,type='application/json;charset=utf-8')=>{const blob=new Blob([text],{type});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();setTimeout(()=>URL.revokeObjectURL(url),1000);};

  async function loadQuestions(){
    try{
      const res = await fetch('questions.json', { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const obj = await res.json();
      if(obj.version) QUIZ_VERSION=obj.version;
      BANK_A = Array.isArray(obj.A)? obj.A: [];
      BANK_B1= Array.isArray(obj.B1)?obj.B1:[];
      BANK_B2= Array.isArray(obj.B2)?obj.B2:[];
      console.log('Loaded questions.json', {A:BANK_A.length,B1:BANK_B1.length,B2:BANK_B2.length,version:QUIZ_VERSION});
    }catch(e){
      console.error('è¼‰å…¥ questions.json å¤±æ•—ï¼š', e);
      alert('ç„¡æ³•è¼‰å…¥ questions.jsonã€‚è«‹ç¢ºèªèˆ‡ index.html åŒç›®éŒ„ï¼Œä¸” GitHub Pages å·²éƒ¨ç½²å®Œæˆã€‚');
    }
  }

  // ========= æœ¬æ©Ÿçµ±è¨ˆ/æ’è¡Œæ¦œï¼ˆé›²ç«¯å¤±æ•—æ™‚ä½¿ç”¨ï¼‰ =========
  const STORAGE = { state:'agri_quiz_state', people:'agri_quiz_people', board:'agri_quiz_board' };
  const getPeople=()=>parseInt(localStorage.getItem(STORAGE.people)||'0',10);
  const setPeople=(n)=>localStorage.setItem(STORAGE.people,String(n));
  const renderPeople=()=>$('#peopleCount').textContent=String(getPeople()).padStart(6,'0')+' äºº';
  const getBoard=()=>{ try{return JSON.parse(localStorage.getItem(STORAGE.board)||'[]');}catch{return [];} };
  const pushBoard=(rec)=>{ const arr=getBoard(); arr.push(rec); arr.sort((a,b)=>b.score-a.score); localStorage.setItem(STORAGE.board, JSON.stringify(arr.slice(0,50))); };

  // ========= Firebase APIï¼ˆè«‹æŠŠ <YOUR_PROJECT_ID> æ›æˆå¯¦éš›å°ˆæ¡ˆ IDï¼‰ =========
  const API_BASE = 'https://asia-east1-agri-plant-quiz.cloudfunctions.net/api';
let CLOUD_OK = false; // è‹¥é›²ç«¯ä¸å¯ç”¨ï¼Œæ’è¡Œæ¦œèˆ‡é€åˆ†å°‡è‡ªå‹•é€€å›æœ¬æ©Ÿ
  async function cloudSubmitScore(record){
  try{
    if(!CLOUD_OK) return null; // é›²ç«¯æœªé€£ç·šæ™‚ç›´æ¥ç•¥é
    const res = await fetch(API_BASE + '/submit', {
      method:'POST', mode:'cors', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name:record.name, type:record.type, score:Number(record.score), version:record.version })
    });
    if(!res.ok) throw new Error('submit failed '+res.status);
    return await res.json();
  }catch(e){ console.warn('submit error', e); return null; }
},
        body: JSON.stringify({ name:record.name, type:record.type, score:Number(record.score), version:record.version })
      });
      if(!res.ok) throw new Error('submit failed');
      return await res.json();
    }catch(e){ console.warn('submit error', e); return null; }
  }
  async function cloudFetchTop10(){
  try{
    if(!CLOUD_OK) return [];
    const res = await fetch(API_BASE + '/top10', {mode:'cors'});
    if(!res.ok) throw new Error('fetch top10 failed '+res.status);
    return await res.json();
  }catch(e){ console.warn('top10 error', e); return []; }
}catch(e){ console.warn('top10 error', e); return []; }
  }

  // ========= é¡Œåº«åŒ¯å‡º =========
  $('#btnExportQ')?.addEventListener('click',()=>{
    const obj={version:QUIZ_VERSION,A:BANK_A,B1:BANK_B1,B2:BANK_B2};
    download(`questions_${QUIZ_VERSION}.json`, JSON.stringify(obj,null,2));
  });

  // ========= æ¸¬é©—ç‹€æ…‹èˆ‡çºŒç­” =========
  const STATE = { user:"", type:"", questions:[], idx:0, timerSec:20*60, score:0, startedAt:0 };
  let timerId=null, autosaveId=null;
  const saveState=()=>localStorage.setItem(STORAGE.state, JSON.stringify({ ...STATE, version:QUIZ_VERSION }));
  const clearState=()=>localStorage.removeItem(STORAGE.state);
  const loadState=()=>{ try{return JSON.parse(localStorage.getItem(STORAGE.state)||'null');}catch{return null;} };
  function showResumeIfAny(){
    const s=loadState();
    if(s && s.version===QUIZ_VERSION && s.questions?.length){
      $('#resumeInfo').textContent=`${s.user}ï¼${s.type==='A'?'A.èªè­˜ä½œç‰©':'B.ç—…èŸ²è‰å®³èˆ‡é˜²æ²»'}ï¼ˆå‰©é¤˜ ${Math.floor(s.timerSec/60)}:${String(s.timerSec%60).padStart(2,'0')}ï¼‰`;
      $('#resumeBar').style.display='block';
      $('#btnResume').onclick=()=>{ Object.assign(STATE,s); toView('#view-quiz'); onEnterQuizView(); };
      $('#btnDiscard').onclick=()=>{ clearState(); $('#resumeBar').style.display='none'; };
    }
  }

  // ========= é¦–é äº’å‹• =========
  function updateStartBtn(){ const ok=$('#username').value.trim() && $('#testType').value; $('#btnStart').disabled=!ok; }
  $('#username').addEventListener('input', updateStartBtn);
  $('#testType').addEventListener('change', updateStartBtn);
    // é‡å°è‡ªå‹•å¸¶å…¥ï¼ˆç€è¦½å™¨è¨˜ä½/å¯†ç¢¼ç®¡ç†ï¼‰ç‹€æ³ï¼Œåˆå§‹åŒ–æ™‚å°±æª¢æŸ¥ä¸€æ¬¡
    updateStartBtn();
    // æŸäº›ç€è¦½å™¨çš„è‡ªå‹•å¡«å…¥åœ¨ visibilitychange å¾Œæ‰å¯«å…¥ï¼Œä¿éšªå†æª¢æŸ¥ä¸€æ¬¡
    document.addEventListener('visibilitychange', ()=>{ setTimeout(updateStartBtn, 300); });
  $('#btnDemo').addEventListener('click',()=>{ $('#username').value=$('#username').value||'DEMO'; $('#testType').value=$('#testType').value||'A'; startQuiz(true); });
  $('#btnStart').addEventListener('click',()=> startQuiz(false));

  const toView=(id)=>['#view-home','#view-quiz','#view-result'].forEach(v=>$(v).style.display=(v===id)?'block':'none');

  // ========= é¡Œåº«çµ„è£ =========
  function buildQuestions(type,{demo=false}={}){
    const bank = (type==='A') ? [...BANK_A] : [...BANK_B1, ...BANK_B2];
    const TARGET = type==='A'?50:40; const count = demo?Math.min(10,bank.length):TARGET;
    const picked = sampleN(bank, count); const namesAll = bank.map(x=>x.name);
    return picked.map(q=>{ const wrongs=sampleN(namesAll.filter(n=>n!==q.name),3); const options=shuffle([q.name,...wrongs]); return { image:q.image, options, answer:q.name, your:null }; });
  }

  // ========= å•Ÿå‹•/çºŒç­” =========
  function startQuiz(demo){
    STATE.user=$('#username').value.trim();
    STATE.type=$('#testType').value||'A';
    STATE.questions=buildQuestions(STATE.type,{demo});
    STATE.idx=0; STATE.timerSec=20*60; STATE.score=0; STATE.startedAt=Date.now();
    toView('#view-quiz'); onEnterQuizView();
  }
  function onEnterQuizView(){
    $('#badgeType').textContent= STATE.type==='A' ? 'A. èªè­˜ä½œç‰©' : 'B. ç—…èŸ²è‰å®³èˆ‡é˜²æ²»';
    $('#badgeName').textContent=STATE.user;
    $('#badgeVersion2').textContent='ver '+QUIZ_VERSION;
    renderQuestion(); renderPalette(); renderProgress(); startTimer();
    clearInterval(autosaveId); autosaveId=setInterval(saveState,5000);
  }

  // ========= è¨ˆæ™‚å™¨ =========
  function startTimer(){
    clearInterval(timerId);
    timerId=setInterval(()=>{
      STATE.timerSec--; if(STATE.timerSec<=0){ STATE.timerSec=0; updateTimer(); clearInterval(timerId); submitQuiz(true);} else { updateTimer(); }
    },1000);
    updateTimer();
  }
  function updateTimer(){ const m=Math.floor(STATE.timerSec/60), s=STATE.timerSec%60; $('#timer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; saveState(); }

  // ========= é¡Œç›®æ¸²æŸ“ =========
  function renderProgress(){ const percent=((STATE.idx+1)/STATE.questions.length)*100; $('#bar').style.width=percent+'%'; }
  function renderQuestion(){
    const q=STATE.questions[STATE.idx]; const total=STATE.questions.length;
    const html=`<div class="topbar" style="margin:6px 0 10px"><div class="badge">ç¬¬ ${STATE.idx+1} / ${total} é¡Œ</div></div>
      <img class=\"quiz-img\" src=\"${q.image}\" alt=\"è©¦é¡Œåœ–ç‰‡\" onerror=\"this.src='https://placehold.co/900x600?text=Image'\">
      <div class=\"choices\" role=\"group\" aria-label=\"é¸é …\">${q.options.map((opt,i)=>{ const id=\`opt${STATE.idx}_${i}\`; const checked=q.your===opt?'checked':''; return `<label class=\"choice\"><input type=\"radio\" name=\"q${STATE.idx}\" id=\"${id}\" value=\"${opt}\" ${checked}> <span>${opt}</span></label>`; }).join('')}</div>`;
    $('#qwrap').innerHTML=html;
    $$('#qwrap input[type=radio]').forEach(el=>el.addEventListener('change',(e)=>{ STATE.questions[STATE.idx].your=e.target.value; renderPalette(); saveState(); }));
    $('#btnPrev').disabled=STATE.idx===0; $('#btnNext').disabled=STATE.idx===total-1;
  }
  function renderPalette(){
    const frag=document.createDocumentFragment();
    STATE.questions.forEach((q,i)=>{ const b=document.createElement('button'); b.textContent=i+1; b.title=`å‰å¾€ç¬¬ ${i+1} é¡Œ`; if(q.your) b.classList.add('answered'); if(i===STATE.idx) b.classList.add('current'); b.addEventListener('click',()=>{ STATE.idx=i; renderQuestion(); renderProgress(); saveState(); }); frag.appendChild(b); });
    const p=$('#palette'); p.innerHTML=''; p.appendChild(frag);
  }
  $('#btnPrev').addEventListener('click',()=>{ if(STATE.idx>0){ STATE.idx--; renderQuestion(); renderProgress(); saveState(); }});
  $('#btnNext').addEventListener('click',()=>{ if(STATE.idx<STATE.questions.length-1){ STATE.idx++; renderQuestion(); renderProgress(); saveState(); }});
  $('#btnSubmit').addEventListener('click',()=> submitQuiz(false));

  // ========= äº¤å· =========
  async function submitQuiz(auto){
    clearInterval(timerId); clearInterval(autosaveId);
    const per=(STATE.type==='A')?2:2.5; let correct=0;
    STATE.questions.forEach(q=>{ if(q.your===q.answer) correct++; });
    STATE.score=+(correct*per).toFixed(2);
    setPeople(getPeople()+1); renderPeople();
    const rec={ name:STATE.user, type:STATE.type, score:STATE.score, version:QUIZ_VERSION, ts:Date.now() };
    try{ pushBoard(rec); }catch{}
    try{ await cloudSubmitScore(rec); }catch{}
    await renderBoard();
    $('#resName').textContent=`æ‡‰è©¦è€…ï¼š${STATE.user}`;
    $('#resType').textContent=`é¡åˆ¥ï¼š${STATE.type==='A'?'A. èªè­˜ä½œç‰©':'B. ç—…èŸ²è‰å®³èˆ‡é˜²æ²»'}`;
    $('#resScore').textContent=`å¾—åˆ†ï¼š${STATE.score} åˆ†`;
    const passEl=$('#resPass'); passEl.textContent=(STATE.score>=60)?'çµæœï¼šåŠæ ¼':'çµæœï¼šä¸åŠæ ¼'; passEl.style.background=(STATE.score>=60)?'#d1fae5':'#fee2e2'; passEl.style.borderColor=(STATE.score>=60)?'#10b981':'#ef4444';
    $('#resVersion').textContent='ver '+QUIZ_VERSION;
    const tbody=document.createDocumentFragment();
    STATE.questions.forEach((q,idx)=>{ const tr=document.createElement('tr'); const ok=q.your===q.answer; tr.innerHTML=`<td>${idx+1}</td><td><img src="${q.image}" alt="é¡Œåœ–" style="width:120px;height:80px;object-fit:cover;border-radius:8px;border:1px solid #cbd5e1" onerror="this.src='https://placehold.co/240x160'"/></td><td>${q.your? q.your : '<span class="muted">æœªä½œç­”</span>'}</td><td>${q.answer}</td><td>${ ok ? '<span class="ok">âœ” æ­£ç¢º</span>' : '<span class="ng">âœ˜ éŒ¯èª¤</span>'}</td>`; tbody.appendChild(tr); });
    const r=$('#resultBody'); r.innerHTML=''; r.appendChild(tbody);
    toView('#view-result'); clearState();
  }

  // ========= åŒ¯å‡ºçµæœ =========
  const toCSV=()=>{ const header=['name','type','version','score','index','your','answer','correct','image']; const rows=[]; STATE.questions.forEach((q,i)=>rows.push([STATE.user,STATE.type,QUIZ_VERSION,STATE.score,i+1,q.your||'',q.answer,(q.your===q.answer)?'1':'0',q.image])); const lines=[header.join(','), ...rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','))]; return lines.join('\n'); };
  const toJSONRes=()=> JSON.stringify({ name:STATE.user, type:STATE.type, version:QUIZ_VERSION, score:STATE.score, items:STATE.questions.map((q,i)=>({ index:i+1, your:q.your, answer:q.answer, correct:q.your===q.answer, image:q.image })) }, null, 2);
  $('#btnDownloadCSV').addEventListener('click',()=> download(`agri_quiz_${Date.now()}.csv`, toCSV(), 'text/csv;charset=utf-8'));
  $('#btnDownloadJSON').addEventListener('click',()=> download(`agri_quiz_${Date.now()}.json`, toJSONRes()));
  $('#btnPrint').addEventListener('click',()=> window.print());
  $('#btnAgain').addEventListener('click',()=>{ toView('#view-home'); renderPeople(); renderBoard(); showResumeIfAny(); });

  // ========= æ’è¡Œæ¦œæ¸²æŸ“ï¼ˆé›²ç«¯å„ªå…ˆï¼Œå¤±æ•—è½å›æœ¬æ©Ÿï¼‰ =========
  async function renderBoard(){
  let data = [];
  try{ if(CLOUD_OK) data = await cloudFetchTop10(); }catch{}
  if(!data || !data.length){ data = getBoard(); }
  const tb=$('#boardBody'); tb.innerHTML='';
  if(!data.length){ tb.innerHTML='<tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr>'; return; }
  data.slice(0,10).forEach((r,i)=>{ const tr=document.createElement('tr'); const t=new Date(r.ts||Date.now()); tr.innerHTML=`<td>${i+1}</td><td>${r.name||''}</td><td>${r.type||''}</td><td>${(typeof r.score==='number')? r.score.toFixed(2): r.score}</td><td>${t.toLocaleString()}</td><td>${r.version||''}</td>`; tb.appendChild(tr); });
}catch{}
    if(!data || !data.length){ data = getBoard(); }
    const tb=$('#boardBody'); tb.innerHTML='';
    if(!data.length){ tb.innerHTML='<tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™</td></tr>'; return; }
    data.slice(0,10).forEach((r,i)=>{ const tr=document.createElement('tr'); const t=new Date(r.ts||Date.now()); tr.innerHTML=`<td>${i+1}</td><td>${r.name||''}</td><td>${r.type||''}</td><td>${(typeof r.score==='number')? r.score.toFixed(2): r.score}</td><td>${t.toLocaleString()}</td><td>${r.version||''}</td>`; tb.appendChild(tr); });
  }

  // ========= åˆå§‹åŒ– =========
  (async function init(){
  await loadQuestions();
  $('#badgeVersion').textContent='ver '+QUIZ_VERSION;
  // å•Ÿå‹•é›²ç«¯è‡ªæª¢ï¼šå¯ç”¨å‰‡é¡¯ç¤ºç¶ è‰²ï¼Œå¤±æ•—å‰‡é€²å…¥æœ¬æ©Ÿæ¨¡å¼
  try{
    const ctl = new AbortController(); const t = setTimeout(()=>ctl.abort(), 6000);
    const ping = await fetch(API_BASE + '/top10', {mode:'cors', signal: ctl.signal});
    clearTimeout(t);
    if(ping.ok){ CLOUD_OK = true; $('#cloudBadge').textContent='é›²ç«¯ï¼šé€£ç·šæ­£å¸¸'; $('#cloudBadge').style.background='#dcfce7'; }
    else { CLOUD_OK=false; $('#cloudBadge').textContent='é›²ç«¯ï¼šæœªé€£ç·šï¼ˆæ”¹ç”¨æœ¬æ©Ÿï¼‰'; $('#cloudBadge').style.background='#fee2e2'; }
  }catch(e){ CLOUD_OK=false; $('#cloudBadge').textContent='é›²ç«¯ï¼šæœªé€£ç·šï¼ˆæ”¹ç”¨æœ¬æ©Ÿï¼‰'; $('#cloudBadge').style.background='#fee2e2'; console.warn('Cloud unreachable', e); }
  renderPeople();
  renderBoard();
  showResumeIfAny();
})();
  </script>
</body>
</html>
